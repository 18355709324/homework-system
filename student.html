<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作业提交系统 - 学生端</title>
    <!-- 更新 Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #1a237e;
            margin: 0;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .login-form input, .login-form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .login-form button {
            padding: 12px;
            background: #1a237e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .login-form button:hover {
            background: #0d1657;
        }
        .student-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .submit-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .submit-button:hover {
            background: #388e3c;
        }
        .withdraw-button {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            margin-left: 10px;
        }
        .withdraw-button:hover {
            background: #f57c00;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 14px;
            margin-top: 10px;
        }
        .status-unsubmitted {
            background: #f5f5f5;
            color: #666;
        }
        .status-submitted {
            background: #4caf50;
            color: white;
        }
        .status-needs-revision {
            background: #ff9800;
            color: white;
        }
        .status-completed {
            background: #2196f3;
            color: white;
        }
        .feedback {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        #app-container {
            display: none;
        }
        #login-container {
            display: none;
        }
        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="login-container" class="login-container">
        <h2 class="section-title">学生登录</h2>
        <form id="login-form" class="login-form">
            <select id="teacher-select">
                <option value="">请选择老师</option>
            </select>
            <select id="student-select" disabled>
                <option value="">请先选择老师</option>
            </select>
            <button type="submit">进入系统</button>
        </form>
    </div>

    <!-- 主应用界面 -->
    <div id="app-container">
        <button class="logout-button" onclick="logout()">退出登录</button>
        <div class="header">
            <h1>作业提交系统 - 学生端</h1>
        </div>
        <div class="student-card">
            <h2 id="student-name"></h2>
            <div id="status-badge" class="status-badge"></div>
            <div id="feedback" class="feedback"></div>
            <div id="action-buttons">
                <button id="submit-button" class="submit-button" style="display: none">提交作业</button>
                <button id="withdraw-button" class="withdraw-button" style="display: none">撤回提交</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAOYdSYZu4KJ-r69_OShp7OIJsfFwhq76E",
            authDomain: "homework-system-demo-c76ce.firebaseapp.com",
            projectId: "homework-system-demo-c76ce",
            storageBucket: "homework-system-demo-c76ce.firebasestorage.app",
            messagingSenderId: "291861255244",
            appId: "1:291861255244:web:94f2c75e57091994acd0e9",
            databaseURL: "https://homework-system-demo-c76ce-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let currentTeacherId = null;
        let currentStudent = null;
        let studentStatus = {};

        // 加载教师列表
        function loadTeachers() {
            database.ref('teachers').on('value', (snapshot) => {
                const teacherSelect = document.getElementById('teacher-select');
                teacherSelect.innerHTML = '<option value="">请选择老师</option>';
                
                snapshot.forEach((teacherSnapshot) => {
                    const teacherId = teacherSnapshot.key;
                    // 获取教师的个人信息
                    database.ref(`teachers/${teacherId}/profile`).once('value')
                        .then((profileSnapshot) => {
                            const profile = profileSnapshot.val() || {};
                            const teacherName = profile.displayName || `老师 ${teacherId.slice(0, 6)}`;
                            const option = document.createElement('option');
                            option.value = teacherId;
                            option.textContent = teacherName;
                            teacherSelect.appendChild(option);
                        });
                });
            });
        }

        // 当选择教师时加载学生列表
        document.getElementById('teacher-select').addEventListener('change', (e) => {
            const teacherId = e.target.value;
            const studentSelect = document.getElementById('student-select');
            
            if (teacherId) {
                database.ref(`teachers/${teacherId}/students`).once('value')
                    .then((snapshot) => {
                        const students = snapshot.val() || [];
                        studentSelect.innerHTML = '<option value="">请选择你的姓名</option>';
                        
                        // 确保students是数组
                        const studentArray = Array.isArray(students) ? students : Object.values(students);
                        
                        // 按照姓名排序
                        studentArray.sort().forEach(student => {
                            const option = document.createElement('option');
                            option.value = student;
                            option.textContent = student;
                            studentSelect.appendChild(option);
                        });
                        studentSelect.disabled = false;
                    });
            } else {
                studentSelect.innerHTML = '<option value="">请先选择老师</option>';
                studentSelect.disabled = true;
            }
        });

        // 登录表单处理
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const teacherId = document.getElementById('teacher-select').value;
            const studentName = document.getElementById('student-select').value;
            
            if (!teacherId || !studentName) {
                alert('请选择老师和你的姓名');
                return;
            }

            // 检查该学生是否存在于教师的学生列表中
            database.ref(`teachers/${teacherId}/students`).once('value')
                .then((snapshot) => {
                    const students = snapshot.val() || [];
                    if (students.includes(studentName)) {
                        currentTeacherId = teacherId;
                        currentStudent = studentName;
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('app-container').style.display = 'block';
                        document.getElementById('student-name').textContent = studentName;
                        loadStudentStatus();
                    } else {
                        alert('未找到该学生信息，请确认选择是否正确');
                    }
                });
        });

        // 退出登录
        function logout() {
            currentTeacherId = null;
            currentStudent = null;
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('teacher-select').value = '';
            document.getElementById('student-select').innerHTML = '<option value="">请先选择老师</option>';
            document.getElementById('student-select').disabled = true;
        }

        // 加载学生状态
        function loadStudentStatus() {
            database.ref(`teachers/${currentTeacherId}/studentStatus/${currentStudent}`).on('value', (snapshot) => {
                const status = snapshot.val() || {
                    status: 'unsubmitted',
                    timestamp: null,
                    feedback: []
                };
                updateStudentCard(status);
            });
        }

        // 更新学生卡片显示
        function updateStudentCard(status) {
            const statusBadge = document.getElementById('status-badge');
            const submitButton = document.getElementById('submit-button');
            const withdrawButton = document.getElementById('withdraw-button');
            const feedbackDiv = document.getElementById('feedback');

            // 更新状态标签
            statusBadge.className = `status-badge status-${status.status}`;
            statusBadge.textContent = getStatusText(status.status);

            // 更新按钮显示
            submitButton.style.display = status.status === 'unsubmitted' ? 'inline-block' : 'none';
            withdrawButton.style.display = status.status === 'submitted' ? 'inline-block' : 'none';

            // 更新反馈信息
            if (status.feedback && status.feedback.length > 0) {
                const latestFeedback = status.feedback[status.feedback.length - 1];
                feedbackDiv.textContent = `老师反馈：${latestFeedback.text}`;
            } else {
                feedbackDiv.textContent = '';
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'unsubmitted': '未提交',
                'submitted': '已提交',
                'needs-revision': '需订正',
                'completed': '已完成'
            };
            return statusMap[status] || status;
        }

        // 提交作业
        document.getElementById('submit-button').onclick = () => {
            const updates = {
                status: 'submitted',
                timestamp: new Date().toISOString()
            };
            
            database.ref(`teachers/${currentTeacherId}/studentStatus/${currentStudent}`)
                .update(updates)
                .catch(error => {
                    console.error("Error submitting homework:", error);
                    alert("提交失败，请重试");
                });
        };

        // 撤回提交
        document.getElementById('withdraw-button').onclick = () => {
            const updates = {
                status: 'unsubmitted',
                timestamp: new Date().toISOString()
            };
            
            database.ref(`teachers/${currentTeacherId}/studentStatus/${currentStudent}`)
                .update(updates)
                .catch(error => {
                    console.error("Error withdrawing submission:", error);
                    alert("撤回失败，请重试");
                });
        };

        // 页面加载时初始化
        window.onload = () => {
            document.getElementById('login-container').style.display = 'block';
            loadTeachers();
        };
    </script>
</body>
</html> 